<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Rnet Social</title>

<style>
body{
  margin:0;
  font-family:Arial;
  background:#0f0f0f;
  color:white;
}

.container{
  max-width:500px;
  margin:auto;
  padding:20px;
}

input, textarea{
  width:100%;
  padding:10px;
  margin:5px 0;
  border:none;
  border-radius:8px;
}

button{
  padding:10px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  background:#5865f2;
  color:white;
  width:100%;
  margin-top:5px;
}

.card{
  background:#1a1a1a;
  padding:15px;
  border-radius:12px;
  margin-top:15px;
}

img, video{
  width:100%;
  border-radius:12px;
  margin-top:10px;
}
</style>
</head>
<body>

<div class="container">

<h2>Rnet Social</h2>

<div id="authArea">
<input type="email" id="email" placeholder="Email">
<input type="password" id="password" placeholder="Senha">
<button onclick="register()">Cadastrar</button>
<button onclick="login()">Entrar</button>
</div>

<div id="app" style="display:none;">

<h3>Perfil</h3>
<p id="usernameDisplay"></p>
<p>Seguidores: <span id="followersCount">0</span></p>
<p>Seguindo: <span id="followingCount">0</span></p>

<hr>

<h3>Criar Post</h3>
<input type="text" id="mediaUrl" placeholder="Link da imagem ou vídeo">
<textarea id="caption" placeholder="Legenda"></textarea>
<button onclick="createPost()">Postar</button>

<hr>

<h3>Feed</h3>
<div id="feed"></div>

</div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, increment, addDoc, collection, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBx7BsWrobnUbJ4hzToB_37070IdEzBkEc",
  authDomain: "rnet-social.firebaseapp.com",
  projectId: "rnet-social",
  storageBucket: "rnet-social.firebasestorage.app",
  messagingSenderId: "790663478354",
  appId: "1:790663478354:web:63f74fe51ea6d23948338b"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();

let currentUser = null;

window.register = async () => {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  const userCred = await createUserWithEmailAndPassword(auth,email,password);
  const user = userCred.user;

  await setDoc(doc(db,"users",user.uid),{
    username: email.split("@")[0],
    followersCount:0,
    followingCount:0,
    verified:false
  });

  alert("Conta criada!");
};

window.login = async () => {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  await signInWithEmailAndPassword(auth,email,password);
};

onAuthStateChanged(auth, async (user)=>{
  if(user){
    currentUser = user;
    document.getElementById("authArea").style.display="none";
    document.getElementById("app").style.display="block";

    const snap = await getDoc(doc(db,"users",user.uid));
    const data = snap.data();

    document.getElementById("usernameDisplay").innerText =
      data.username + (data.verified ? " ✔" : "");

    document.getElementById("followersCount").innerText = data.followersCount;
    document.getElementById("followingCount").innerText = data.followingCount;

    loadFeed();
  }
});

window.createPost = async () => {
  const mediaUrl = document.getElementById("mediaUrl").value;
  const caption = document.getElementById("caption").value;

  const userSnap = await getDoc(doc(db,"users",currentUser.uid));
  const userData = userSnap.data();

  await addDoc(collection(db,"Post"),{
    uid:currentUser.uid,
    username:userData.username,
    mediaUrl:mediaUrl,
    caption:caption,
    timestamp:serverTimestamp()
  });

  alert("Post criado!");
  loadFeed();
};

async function loadFeed(){
  const feed = document.getElementById("feed");
  feed.innerHTML="";

  const querySnapshot = await getDocs(collection(db,"Post"));

  querySnapshot.forEach((docSnap)=>{
    const data = docSnap.data();

    const div = document.createElement("div");
    div.className="card";

    div.innerHTML = `
      <b>${data.username}</b>
      <p>${data.caption}</p>
      ${data.mediaUrl.includes("mp4") ?
        `<video controls src="${data.mediaUrl}"></video>` :
        `<img src="${data.mediaUrl}">`
      }
    `;

    feed.appendChild(div);
  });
}

</script>
</body>
</html>
