<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>MV Zone</title>

<style>
body { font-family: Arial; background:#111; color:white; text-align:center; }
input, button { margin:5px; padding:8px; }
.mv { background:#1c1c1c; padding:10px; margin:10px; border-radius:10px; }
.rank { font-size:20px; color:#00ffcc; }
.vote img { width:30px; cursor:pointer; margin:5px; }
.comment { background:#222; margin:5px; padding:5px; border-radius:5px; }
</style>
</head>
<body>

<h1>MV ZONE</h1>

<div id="loginArea">
<h3>Entrar</h3>
<input id="companyName" placeholder="Empresa">
<input id="companyPass" type="password" placeholder="Senha">
<button onclick="loginCompany()">Entrar como Empresa</button>
<button onclick="enterVisitor()">Entrar como Visitante</button>
</div>

<div id="companyArea" style="display:none;">
<h3>Painel da Empresa</h3>
<input id="artistInput" placeholder="Artista">
<input id="mvLinkInput" placeholder="Link do YouTube">
<button onclick="addMV()">Adicionar MV</button>
</div>

<h2>Charts</h2>
<div id="mvList"></div>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDa1Lm_bSz18M11gT0CZio-CG0mOqvBd7I",
  authDomain: "mvzone-29363.firebaseapp.com",
  projectId: "mvzone-29363",
  };

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let currentCompany = null;
let isCompany = false;

// Entrar visitante
function enterVisitor(){
  document.getElementById("loginArea").style.display="none";
}

// Login empresa
async function loginCompany(){
  const name = document.getElementById("companyName").value;
  const pass = document.getElementById("companyPass").value;

  const doc = await db.collection("companies").doc(name).get();

  if(doc.exists){
    if(doc.data().password === pass){
      currentCompany = name;
      isCompany = true;
      document.getElementById("loginArea").style.display="none";
      document.getElementById("companyArea").style.display="block";
    }else{
      alert("Senha errada");
    }
  }else{
    await db.collection("companies").doc(name).set({
      password: pass,
      lastPost: 0
    });
    alert("Empresa criada, entre novamente");
  }
}

// Converter link YouTube
function convertLink(url){
  let id = "";
  if(url.includes("youtu.be/")){
    id = url.split("youtu.be/")[1].split("?")[0];
  }else if(url.includes("v=")){
    id = url.split("v=")[1].split("&")[0];
  }
  return "https://www.youtube.com/embed/" + id;
}

// Adicionar MV (1 por semana)
async function addMV(){
  const artist = document.getElementById("artistInput").value;
  const link = document.getElementById("mvLinkInput").value;

  const companyDoc = await db.collection("companies").doc(currentCompany).get();
  const lastPost = companyDoc.data().lastPost || 0;
  const now = Date.now();

  if(now - lastPost < 7*24*60*60*1000){
    alert("Você só pode postar 1 MV por semana");
    return;
  }

  await db.collection("mvs").add({
    artist: artist,
    url: convertLink(link),
    company: currentCompany,
    likes: 0,
    created: now
  });

  await db.collection("companies").doc(currentCompany).update({
    lastPost: now
  });

  alert("MV enviado!");
}

// Votar
async function vote(id, value){
  const ref = db.collection("mvs").doc(id);
  const doc = await ref.get();
  const likes = doc.data().likes + value;
  await ref.update({likes: likes});
}

// Comentário
async function addComment(mvId){
  const text = prompt("Comentário:");
  if(!text) return;

  const name = isCompany ? currentCompany : "Visitante";

  await db.collection("comments").add({
    mvId: mvId,
    name: name,
    text: text,
    created: Date.now()
  });
}

// Carregar MVs
db.collection("mvs").orderBy("likes","desc").onSnapshot(snapshot=>{
  const container = document.getElementById("mvList");
  container.innerHTML="";
  let rank = 1;

  snapshot.forEach(doc=>{
    const data = doc.data();
    const mv = document.createElement("div");
    mv.className="mv";

    mv.innerHTML=`
      <div class="rank">#${rank}</div>
      <h3>${data.artist}</h3>
      <p>${data.company}</p>
      <iframe width="300" height="170" src="${data.url}" allowfullscreen></iframe>
      <div class="vote">
        <img src="like.png" onclick="vote('${doc.id}',1)">
        <img src="deslike.png" onclick="vote('${doc.id}',-1)">
      </div>
      <p>Pontos: ${data.likes}</p>
      <button onclick="addComment('${doc.id}')">Comentar</button>
      <div id="comments-${doc.id}"></div>
    `;

    container.appendChild(mv);

    // carregar comentários
    db.collection("comments")
      .where("mvId","==",doc.id)
      .orderBy("created")
      .onSnapshot(cSnap=>{
        const cDiv = document.getElementById("comments-"+doc.id);
        if(!cDiv) return;
        cDiv.innerHTML="";
        cSnap.forEach(c=>{
          const d = c.data();
          const el = document.createElement("div");
          el.className="comment";
          el.innerHTML=`<b>${d.name}:</b> ${d.text}`;
          cDiv.appendChild(el);
        });
      });

    rank++;
  });
});
</script>

</body>
</html>
