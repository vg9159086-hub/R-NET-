<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>MVZONE</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<style>
body{margin:0;font-family:Arial;background:#0f0f0f;color:white}
header{background:#111;padding:10px;text-align:center}
.logo{height:55px}
nav button{background:#ff0055;color:white;border:none;padding:8px 14px;margin:5px;border-radius:6px;cursor:pointer}
.card{background:#181818;padding:15px;margin:15px;border-radius:12px;transition:0.3s}
.voteImg{width:40px;cursor:pointer;margin:6px}
.hidden{display:none}
.top1{border:2px solid gold;box-shadow:0 0 20px gold;animation:glow 1.5s infinite alternate}
@keyframes glow{from{box-shadow:0 0 10px gold}to{box-shadow:0 0 30px gold}}
input{padding:8px;margin:5px;border-radius:6px;border:none}
button{cursor:pointer}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginScreen" style="text-align:center;padding:40px">
<h2>Entrar como:</h2>
<button onclick="showCompanyLogin()">Empresa</button>
<button onclick="enterVisitor()">Visitante</button>

<div id="companyLogin" class="hidden">
<h3>Login Empresa</h3>
<input id="companyName" placeholder="Nome da empresa"><br>
<input id="companyPass" type="password" placeholder="Senha"><br>
<button onclick="loginCompany()">Entrar</button>
<button onclick="registerCompany()">Cadastrar</button>
</div>
</div>

<!-- SITE -->
<div id="site" class="hidden">

<!-- AVISO LEMBRETE -->
<div style="
width:90%;
max-width:600px;
margin:20px auto;
background:#1a1a1a;
border:2px solid gold;
border-radius:12px;
padding:20px;
text-align:center;
box-shadow:0 0 20px gold;
animation:glow 1.5s infinite alternate;
">
<h3 style="color:gold;margin-bottom:10px;">‚ö† LEMBRETE</h3>
<p style="line-height:1.6;color:#ddd;">
TODO M√äS O CHART RESETA.<br><br>
Voc√™ precisa colocar seu grupo novamente.<br><br>
Recomendamos olhar o site pelo menos <strong>1 vez por semana</strong>.
</p>
</div>

<header>
<img src="logo.png" class="logo">
<nav>
<button onclick="showCharts()">Charts</button>
<button onclick="showHistory()">Hist√≥ria</button>
<button onclick="showHall()">Hall da Fama</button>
<button id="logoutBtn" onclick="logout()" class="hidden">Sair</button>
</nav>
</header>

<div id="companyPanel" class="hidden" style="padding:20px">
<h3>Adicionar MV</h3>
<input id="artistInput" placeholder="Nome do artista"><br>
<input id="musicInput" placeholder="Nome da m√∫sica"><br>
<input id="urlInput" placeholder="URL YouTube"><br>
<button onclick="addMV()">Adicionar</button>
</div>

<div id="charts"></div>

<div id="history" class="hidden" style="padding:20px">
<h2>Sobre o R-net</h2>
<p>
o R-net surgiu de uma ideia rescente, ap√≥s uma reuni√£o de colaboradores surgiu o R-net, esse site consiste em existir um chart autom√°tico para o Rpop e KUV, ele atualiza automaticamente, toda semana o placar zera e come√ßa novamente, depois de 30 dias os MVS s√£o removidos e podem ser adicionados apenas MVS rescentes (2 meses) no m√°ximo, os grupos/solistas contam com seus f√£s para ganhar o primeiro lugar na parada musical do rpop/kuv, contamos com o apoio de todos voc√™s para crescermos a popularidade de cada um
</p>
</div>

<div id="hall" class="hidden" style="padding:20px"></div>

</div>

<script>
const firebaseConfig={
apiKey: "AIzaSyDa1Lm_bSz18M11gT0CZio-CG0mOqvBd7I",
authDomain: "mvzone-29363.firebaseapp.com",
projectId: "mvzone-29363",
};

firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();

let currentCompany=null;
let currentFirst=null;
const victorySound=new Audio("victory.mp3");

/* LOGIN */
function showCompanyLogin(){document.getElementById("companyLogin").classList.remove("hidden");}
function enterVisitor(){document.getElementById("loginScreen").classList.add("hidden");document.getElementById("site").classList.remove("hidden");}
async function registerCompany(){const name=companyName.value;const pass=companyPass.value;await db.collection("companies").doc(name).set({password:pass});alert("Empresa cadastrada!");}
async function loginCompany(){const name=companyName.value;const pass=companyPass.value;const doc=await db.collection("companies").doc(name).get();if(doc.exists && doc.data().password===pass){currentCompany=name;document.getElementById("loginScreen").classList.add("hidden");document.getElementById("site").classList.remove("hidden");document.getElementById("companyPanel").classList.remove("hidden");document.getElementById("logoutBtn").classList.remove("hidden");}else{alert("Login inv√°lido");}}
function logout(){location.reload();}

/* ADICIONAR MV */
async function addMV(){if(!currentCompany)return;await db.collection("mvs").add({artist:artistInput.value,title:musicInput.value,url:urlInput.value,company:currentCompany,points:0,createdAt:firebase.firestore.FieldValue.serverTimestamp()});artistInput.value="";musicInput.value="";urlInput.value="";}

/* VOTAR */
async function vote(id,val){const ref=db.collection("mvs").doc(id);const doc=await ref.get();await ref.update({points:(doc.data().points||0)+val});}

/* REMOVER MV ANTIGO */
async function removeOld(){const now=new Date();const snap=await db.collection("mvs").get();snap.forEach(doc=>{if(!doc.data().createdAt)return;const days=(now-doc.data().createdAt.toDate())/(1000*60*60*24);if(days>30)doc.ref.delete();});}
removeOld();

/* CHART */
db.collection("mvs").orderBy("points","desc")
.onSnapshot(snap=>{
charts.innerHTML="";
let pos=1;
let newFirst=null;

snap.forEach(doc=>{
const d=doc.data();
if(pos===1)newFirst=doc.id;

charts.innerHTML+=`
<div class="card ${pos===1?'top1':''}">
<h3>#${pos} ${d.artist} ${pos===1?'üèÜ':''}</h3>
<p>${d.title}</p>
<p>Empresa: ${d.company}</p>
<iframe width="100%" height="220"
src="https://www.youtube.com/embed/${extractID(d.url)}"
frameborder="0" allowfullscreen></iframe>
<p>Pontos: ${d.points||0}</p>
<img src="like.png" class="voteImg" onclick="vote('${doc.id}',1)">
<img src="deslike.png" class="voteImg" onclick="vote('${doc.id}',-1)">
${currentCompany===d.company?`<button onclick="deleteMV('${doc.id}')">Remover</button>`:""}
</div>`;
pos++;
});

if(currentFirst && currentFirst!==newFirst){
victorySound.play();
confetti({particleCount:200,spread:100});
}
currentFirst=newFirst;
});

/* DELETAR */
async function deleteMV(id){await db.collection("mvs").doc(id).delete();}

/* HALL */
function showHall(){charts.classList.add("hidden");history.classList.add("hidden");hall.classList.remove("hidden");db.collection("mvs").orderBy("points","desc").limit(1).get().then(snap=>{hall.innerHTML="<h2>üèÜ L√≠der Atual</h2>";snap.forEach(doc=>{const d=doc.data();hall.innerHTML+=`<div class="card"><h3>${d.artist}</h3><p>${d.title}</p><p>${d.points} pontos</p></div>`;});});}
function showCharts(){charts.classList.remove("hidden");history.classList.add("hidden");hall.classList.add("hidden");}
function showHistory(){charts.classList.add("hidden");history.classList.remove("hidden");hall.classList.add("hidden");}
function extractID(url){const regExp=/(?:youtube\.com\/.*v=|youtu\.be\/)([^&]+)/;const match=url.match(regExp);return match?match[1]:"";}

/* RESET SEMANAL */
async function weeklyReset(){
  const today = new Date();
  const monday = new Date(today);
  monday.setDate(today.getDate() - today.getDay() + 1);
  const weekString = monday.toISOString().split("T")[0];

  const configRef = db.collection("system").doc("config");
  const configDoc = await configRef.get();

  if(!configDoc.exists){
    await configRef.set({ lastReset: "" });
    return;
  }

  if(configDoc.data().lastReset === weekString) return;

  const snap = await db.collection("mvs").orderBy("points","desc").get();
  let ranking = [];
  let pos = 1;

  for(const doc of snap.docs){
    const d = doc.data();
    ranking.push({artist:d.artist,title:d.title,company:d.company,points:d.points,position:pos});
    await doc.ref.update({ points:0 });
    pos++;
  }

  await db.collection("weeklyCharts").doc(weekString).set({week:weekString,ranking:ranking,createdAt:firebase.firestore.FieldValue.serverTimestamp()});
  await configRef.update({lastReset:weekString});
  console.log("Ranking semanal salvo:", weekString);
}

weeklyReset();
</script>

</body>
</html>
