<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>MVZONE</title>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDa1Lm_bSz18M11gT0CZio-CG0mOqvBd7I",
  authDomain: "mvzone-29363.firebaseapp.com",
  projectId: "mvzone-29363",
  };

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let lastPositions = {};
let currentFirst = null;
const victorySound = new Audio("victory.mp3");

/* ========================= */
/* REGRAS */
/* ========================= */

function acceptRules(){
  localStorage.setItem("rulesAccepted","yes");
  document.getElementById("rulesScreen").style.display="none";
}

if(localStorage.getItem("rulesAccepted")==="yes"){
  document.getElementById("rulesScreen").style.display="none";
}

/* ========================= */
/* NAVEGA√á√ÉO */
/* ========================= */

function showCharts(){
  charts.classList.remove("hidden");
  history.classList.add("hidden");
  hall.classList.add("hidden");
}

function showHistory(){
  charts.classList.add("hidden");
  history.classList.remove("hidden");
  hall.classList.add("hidden");
}

function showHall(){
  charts.classList.add("hidden");
  history.classList.add("hidden");
  hall.classList.remove("hidden");

  hall.innerHTML = "<h2>üèÜ Hall da Fama Mensal</h2>";

  db.collection("hallOfFame")
  .orderBy("createdAt","desc")
  .onSnapshot(snapshot=>{
    hall.innerHTML = "<h2>üèÜ Hall da Fama Mensal</h2>";

    snapshot.forEach(doc=>{
      const d = doc.data();
      hall.innerHTML += `
        <div class="card">
          <h3>${d.month}</h3>
          <p><b>${d.artist}</b> - ${d.title}</p>
          <p>Empresa: ${d.company || "-"}</p>
          <p>Pontos: ${d.points}</p>
        </div>
      `;
    });
  });
}

/* ========================= */
/* CONFETE */
/* ========================= */

function launchConfetti(){
  const duration = 3000;
  const end = Date.now() + duration;

  const interval = setInterval(()=>{
    if(Date.now() > end) return clearInterval(interval);

    confetti({
      particleCount: 6,
      spread: 70,
      origin: { y: 0.6 }
    });
  },150);
}

/* ========================= */
/* REMOVER MVs > 30 DIAS */
/* ========================= */

async function removeOldMVs(){
  const now = new Date();
  const snapshot = await db.collection("mvs").get();

  snapshot.forEach(doc=>{
    const data = doc.data();
    if(!data.createdAt) return;

    const diffDays = (now - data.createdAt.toDate())/(1000*60*60*24);
    if(diffDays > 30){
      doc.ref.delete();
    }
  });
}

/* ========================= */
/* RESET SEMANAL */
/* ========================= */

async function weeklyReset(){
  const today = new Date();
  const monday = new Date(today);
  monday.setDate(today.getDate() - today.getDay() + 1);
  const weekString = monday.toISOString().split("T")[0];

  const configRef = db.collection("system").doc("config");
  const configDoc = await configRef.get();
  if(!configDoc.exists) return;

  if(configDoc.data().lastReset === weekString) return;

  const snapshot = await db.collection("mvs")
    .orderBy("points","desc")
    .get();

  let ranking = [];
  let position = 1;

  for(const doc of snapshot.docs){
    const d = doc.data();

    ranking.push({
      artist:d.artist,
      title:d.title,
      company:d.company,
      points:d.points,
      position
    });

    await doc.ref.update({
      points:0,
      trophy: position===1
    });

    position++;
  }

  await db.collection("weeklyCharts").doc(weekString).set({
    week:weekString,
    ranking,
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });

  await configRef.update({ lastReset:weekString });
}

/* ========================= */
/* HALL DA FAMA MENSAL */
/* ========================= */

async function monthlyHallOfFame(){
  const now = new Date();
  const monthString = now.getFullYear()+"-"+(now.getMonth()+1);

  const configRef = db.collection("system").doc("config");
  const configDoc = await configRef.get();
  if(!configDoc.exists) return;

  if(configDoc.data().lastMonthly === monthString) return;

  const snapshot = await db.collection("mvs")
    .orderBy("points","desc")
    .limit(1)
    .get();

  if(snapshot.empty) return;

  const winner = snapshot.docs[0].data();

  await db.collection("hallOfFame").doc(monthString).set({
    month:monthString,
    artist:winner.artist,
    title:winner.title,
    company:winner.company,
    points:winner.points,
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });

  await configRef.update({ lastMonthly:monthString });
}

removeOldMVs();
weeklyReset();
monthlyHallOfFame();

/* ========================= */
/* VOTAR */
/* ========================= */

async function vote(id,value){
  const ref = db.collection("mvs").doc(id);
  const doc = await ref.get();

  await ref.update({
    points:(doc.data().points || 0) + value
  });
}

/* ========================= */
/* CHART AO VIVO */
/* ========================= */

db.collection("mvs")
.orderBy("points","desc")
.onSnapshot(snapshot=>{
  charts.innerHTML="";
  let position=1;
  let newFirst=null;

  snapshot.forEach(doc=>{
    const d = doc.data();
    if(position===1) newFirst=doc.id;

    let moveClass="";
    if(lastPositions[doc.id] && lastPositions[doc.id]!==position){
      moveClass="move";
    }
    lastPositions[doc.id]=position;

    charts.innerHTML += `
      <div class="card ${moveClass} ${position===1?'top1':''}">
        <h3>#${position} ${d.artist} ${position===1?'<span class="trophy">üèÜ</span>':''}</h3>
        <p><b>${d.title}</b></p>
        <p>Empresa: ${d.company || "-"}</p>

        <iframe width="100%" height="220"
        src="https://www.youtube.com/embed/${extractID(d.url)}"
        frameborder="0" allowfullscreen></iframe>

        <p>Pontos: ${d.points || 0}</p>

        <img src="like.png" class="voteImg" onclick="vote('${doc.id}',1)">
        <img src="deslike.png" class="voteImg" onclick="vote('${doc.id}',-1)">
      </div>
    `;

    position++;
  });

  if(currentFirst && currentFirst !== newFirst){
    victorySound.play();
    launchConfetti();
  }

  currentFirst = newFirst;
});

/* ========================= */
/* YOUTUBE ID */
/* ========================= */

function extractID(url){
  const regExp = /(?:youtube\.com\/.*v=|youtu\.be\/)([^&]+)/;
  const match = url.match(regExp);
  return match ? match[1] : "";
}
      </script>
