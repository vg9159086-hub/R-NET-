<!DOCTYPE html><html lang="pt">
<head>
<meta charset="UTF-8">
<title>MV Zone</title><style>
body{background:#111;color:#fff;font-family:Arial;text-align:center}
.tela{display:none}
input,button{margin:5px;padding:8px}
.mv{border:1px solid #444;margin:10px;padding:10px}
img.btn{width:40px;cursor:pointer}
</style></head>
<body><h1>MV Zone</h1><!-- TELA INICIAL --><div id="inicio" class="tela">
<h3>Bem-vindo</h3>
<button onclick="mostrarLogin()">Entrar / Registrar</button>
<button onclick="abrirCharts()">Ver Charts</button>
</div><!-- LOGIN --><div id="login" class="tela">
<h3>Login</h3>
<input id="email" placeholder="Email"><br>
<input id="senha" type="password" placeholder="Senha"><br><select id="tipo">
<option value="visitante">Visitante</option>
<option value="empresa">Empresa</option>
</select><br><input id="empresaNome" placeholder="Nome da Empresa (se empresa)"><br>

<button onclick="registrar()">Registrar</button>
<button onclick="entrar()">Entrar</button><br>
<button onclick="voltarInicio()">Voltar</button>

</div><!-- CHARTS --><div id="charts" class="tela">
<button onclick="logout()">Sair</button>
<h2>Chart Semanal</h2>
<div id="lista"></div>
</div><script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, getDoc, setDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
apiKey: "AIzaSyDa1Lm_bSz18M11gT0CZio-CG0mOqvBd7I",
  authDomain: "mvzone-29363.firebaseapp.com",
  projectId: "mvzone-29363",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();

let userData=null;

// CONTROLE DE TELAS
function mostrarTela(id){
document.querySelectorAll(".tela").forEach(t=>t.style.display="none");
document.getElementById(id).style.display="block";
}

window.mostrarLogin = ()=>mostrarTela("login");
window.voltarInicio = ()=>mostrarTela("inicio");
window.abrirCharts = ()=>{
mostrarTela("charts");
carregarMVs();
}

// REGISTRAR
window.registrar = async ()=>{
let cred=await createUserWithEmailAndPassword(auth,email.value,senha.value);

await setDoc(doc(db,"users",cred.user.uid),{
tipo:tipo.value,
empresa:empresaNome.value
});

alert("Conta criada!");
}

// LOGIN
window.entrar = ()=>{
signInWithEmailAndPassword(auth,email.value,senha.value)
.then(()=>mostrarTela("charts"))
.catch(()=>alert("Erro no login"));
}

// LOGOUT
window.logout = ()=>{
signOut(auth);
mostrarTela("inicio");
}

// NÃƒO PULAR TELA AUTOMATICAMENTE
onAuthStateChanged(auth, async(user)=>{
if(user){
let docu=await getDoc(doc(db,"users",user.uid));
userData=docu.data();
}
});

// CARREGAR MVs
async function carregarMVs(){
let lista=document.getElementById("lista");
lista.innerHTML="";

let semana=Date.now()-7*24*60*60*1000;

let q=query(collection(db,"mvs"),orderBy("likes","desc"));
let snap=await getDocs(q);

let rank=1;

snap.forEach(docu=>{
let mv=docu.data();
if(mv.data<semana) return;

let div=document.createElement("div");
div.className="mv";

div.innerHTML=`
<h3>#${rank} - ${mv.artist} (${mv.empresa})</h3>
<iframe width="300" height="170" src="${mv.link}" allowfullscreen></iframe><br>
<img src="like.png" class="btn" onclick="like('${docu.id}',1)">
<img src="deslike.png" class="btn" onclick="like('${docu.id}',-1)">
<p>Pontos: ${mv.likes}</p>
`;

lista.appendChild(div);
rank++;
});
}

// LIKE
window.like = async(id,valor)=>{
let ref=doc(db,"mvs",id);
let snap=await getDoc(ref);
await updateDoc(ref,{
likes:snap.data().likes + valor
});
carregarMVs();
}

// INICIAR NA TELA INICIAL
mostrarTela("inicio");

</script></body>
</html>
