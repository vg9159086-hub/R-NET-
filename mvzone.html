<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>MVZONE</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
  margin:0;
  font-family:Arial;
  background:#0f0f0f;
  color:white;
}

header{
  background:#111;
  padding:15px;
  text-align:center;
  border-bottom:2px solid #222;
}

.logo{
  height:60px;
}

button{
  background:#ff0055;
  color:white;
  border:none;
  padding:8px 14px;
  cursor:pointer;
  border-radius:6px;
}

button:hover{
  opacity:0.8;
}

.card{
  background:#181818;
  padding:15px;
  margin:15px;
  border-radius:12px;
  transition:0.3s;
}

.card:hover{
  transform:scale(1.02);
}

.hidden{
  display:none;
}

.trophy{
  font-size:22px;
  color:gold;
}

input{
  padding:8px;
  margin:5px;
  border-radius:6px;
  border:none;
}

#rulesPage{
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:#000;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  text-align:center;
  padding:20px;
  z-index:999;
}
</style>
</head>
<body>

<div id="rulesPage">
  <img src="logo.png" class="logo">
  <h2>MVZONE Rules</h2>
  <p>
  ‚Ä¢ Unlimited voting allowed<br>
  ‚Ä¢ Use wisely and support your artist<br>
  ‚Ä¢ Give a chance to all MVs here<br>
  ‚Ä¢ If they're here, they were well produced!
  </p>
  <button onclick="enterSite()">Enter MVZONE</button>
</div>

<header>
  <img src="logo.png" class="logo">
  <div>
    <button onclick="showCharts()">Charts</button>
    <button onclick="showHistory()">History</button>
    <button onclick="showLogin()">Company Login</button>
  </div>
</header>

<div id="charts"></div>

<div id="history" class="hidden"></div>

<div id="loginPage" class="hidden" style="padding:20px;">
  <h2>Company Login</h2>
  <input id="companyName" placeholder="Company Name">
  <input id="companyPass" type="password" placeholder="Password">
  <button onclick="login()">Login</button>
</div>

<div id="adminPanel" class="hidden" style="padding:20px;">
  <h2>Company Panel</h2>
  <input id="artist" placeholder="Artist Name">
  <input id="title" placeholder="MV Title">
  <input id="url" placeholder="YouTube Link">
  <button onclick="addMV()">Add MV</button>
  <button onclick="logout()">Logout</button>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDa1Lm_bSz18M11gT0CZio-CG0mOqvBd7I",
  authDomain: "mvzone-29363.firebaseapp.com",
  projectId: "mvzone-29363",
  };

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let loggedCompany = null;

function enterSite(){
  document.getElementById("rulesPage").style.display="none";
  loadMVs();
}

function showCharts(){
  document.getElementById("charts").classList.remove("hidden");
  document.getElementById("history").classList.add("hidden");
  document.getElementById("loginPage").classList.add("hidden");
  document.getElementById("adminPanel").classList.add("hidden");
}

function showHistory(){
  document.getElementById("charts").classList.add("hidden");
  document.getElementById("history").classList.remove("hidden");
  loadHistory();
}

function showLogin(){
  document.getElementById("loginPage").classList.remove("hidden");
}

async function login(){
  const name = companyName.value;
  const pass = companyPass.value;

  const doc = await db.collection("companies").doc(name).get();
  if(doc.exists && doc.data().password === pass){
    loggedCompany = name;
    loginPage.classList.add("hidden");
    adminPanel.classList.remove("hidden");
  } else {
    alert("Wrong login");
  }
}

function logout(){
  loggedCompany = null;
  adminPanel.classList.add("hidden");
}

async function addMV(){
  const artist = document.getElementById("artist").value;
  const title = document.getElementById("title").value;
  const url = document.getElementById("url").value;

  await db.collection("mvs").add({
    artist,
    title,
    company: loggedCompany,
    url,
    points:0,
    trophy:false
  });

  alert("MV Added!");
  loadMVs();
}

async function vote(id,value){
  const ref = db.collection("mvs").doc(id);
  const doc = await ref.get();
  const newPoints = doc.data().points + value;
  await ref.update({points:newPoints});
  loadMVs();
}

async function loadMVs(){
  checkWeeklyReset();

  const snap = await db.collection("mvs").orderBy("points","desc").get();
  charts.innerHTML="";

  let position=1;

  snap.forEach(doc=>{
    const d = doc.data();
    charts.innerHTML += `
      <div class="card">
        <h3>#${position} ${d.artist} ${d.trophy ? '<span class="trophy">üèÜ</span>' : ''}</h3>
        <p>${d.title}</p>
        <iframe width="100%" height="250"
        src="https://www.youtube.com/embed/${extractID(d.url)}"
        frameborder="0" allowfullscreen></iframe>
        <p>Points: ${d.points}</p>
        <button onclick="vote('${doc.id}',1)">üëç</button>
        <button onclick="vote('${doc.id}',-1)">üëé</button>
      </div>
    `;
    position++;
  });
}

function extractID(url){
  const regExp = /(?:youtube\.com\/.*v=|youtu\.be\/)([^&]+)/;
  const match = url.match(regExp);
  return match ? match[1] : "";
}

async function checkWeeklyReset(){
  const today = new Date();
  const monday = new Date(today);
  monday.setDate(today.getDate() - today.getDay() + 1);
  const weekString = monday.toISOString().split("T")[0];

  const configRef = db.collection("system").doc("config");
  const configDoc = await configRef.get();
  if(!configDoc.exists) return;

  if(configDoc.data().lastReset === weekString) return;

  const snap = await db.collection("mvs").orderBy("points","desc").get();
  let ranking=[];
  let pos=1;

  for(const doc of snap.docs){
    const data=doc.data();
    ranking.push({
      artist:data.artist,
      points:data.points,
      position:pos
    });

    await doc.ref.update({
      trophy: pos===1,
      points:0
    });

    pos++;
  }

  await db.collection("weeklyCharts").doc(weekString).set({
    week:weekString,
    ranking
  });

  await configRef.update({
    lastReset:weekString
  });
}

async function loadHistory(){
  const snap = await db.collection("weeklyCharts").orderBy("week","desc").get();
  history.innerHTML="";
  snap.forEach(doc=>{
    const d=doc.data();
    history.innerHTML += `
      <div class="card">
        <h3>Week ${d.week}</h3>
        ${d.ranking.map(r=>`<p>#${r.position} ${r.artist} (${r.points})</p>`).join("")}
      </div>
    `;
  });
}
</script>

</body>
</html>
